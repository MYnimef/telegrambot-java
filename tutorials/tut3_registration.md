# Добавление регистрации/запроса ввода

### ATTENTION!!! Контент ниже предполагает добавление в проект базы данных или иного способа сохранения данных (го сохранять их в текстовый файл). Лично я предпочитаю использование Spring framework - в тырнете полно гайдов на эту тему.

Представим ситуацию - вы хотите, чтобы после ввода пользователя одной из команд бот запросил у него ввод каких-либо данных. 
Или же вы вовсе хотите добавить функционал регистрации в свой бот. Как это сделать? Что-ж, давайте разбираться.

### Добавление стадий

Так как телеграмм никак не сохраняет состояние пользователя в текущий момент эта задача ложится на нас. Состояния пользователя 
это то, на каком этапе он находится при взаимодействии с ботом. Рассмотрим простой пример - нам нужно добавить регистрацию 
пользователей, для сбора определенных данных - имени, города и возраста (привет дайвинчик). Для этого для начала реализуем 
перечисление (enum) состояний:

```java
public enum MyUserState {
    UNAUTHORIZED,
    SET_NAME, 
    SET_CITY,
    SET_AGE,
    AUTHORIZED
}
```

Разберем зачем нужны все эти состояния: 

- UNAUTHORIZED - это состояние мы будем выдавать всем тем, кого нет в нашей базе данных (те, кто пишет боту первый раз);
- SET_NAME - состояние, при котором мы будем ожидать от пользователя ввода имени;
- SET_CITY - состояние, при котором мы будем ожидать от пользователя ввода города;
- SET_AGE - состояние, при котором мы будем ожидать от пользователя ввода возраста;
- AUTHORIZED - авторизированное состояние, при котором любой ввод пользователя будет расцениваться как ввод команды.

Вопрос в следующем - что нам делать с этими состояниями? Хороший вопрос, продолжаем углубление...

### Создание обработчика стадий

По аналогии с добавлением своих команд, нам нужно создать класс, наследованный от RegistrationBuilder:

```java
public class MyRegistrationBuilder extends RegistrationBuilder<MyUserState> {
    @Override
    public void initialize() {
        
    }
}
```

Давайте разберем то, что мы сделали. RegistrationBuilder это шаблонный класс (не кидайтесь камнями - я спал очень мало, могу допускать 
ошибки в формулировках). Суть в том, что RegistrationBuilder<сюда мы вставляем наш только что созданный enum>.

Разберем добавление стадий регистрации... 

```java
public class MyRegistrationBuilder extends RegistrationBuilder<MyUserState> {
    @Override
    public void initialize() {
        add(
                MyUserState.UNAUTHORIZED,
                "Ты кто такой?"
        );
    }
}
```

Выше мы добавили сообщение, которое будет высылаться всем пользователям со стадией UNAUTHORIZED. Давайте заполним остальные стадии:

```java
public class MyRegistrationBuilder extends RegistrationBuilder<MyUserState> {
    @Override
    public void initialize() {
        add(
                MyUserState.UNAUTHORIZED,
                "Ты кто такой?"
        );

        add(
                MyUserState.SET_NAME,
                "Крутое имя, бро",
                "пчел, тыыыы",
                (input, chatId) -> { какая-то логика с возвращаемым значением типа boolean }
        );

        add(
                MyUserState.SET_CITY,
                "Я тоже из мухосрани",
                "пчел, тыыыыыыыыыыыыыыыыыыы",
                (input, chatId) -> { какая-то другая логика с возвращаемым значением типа boolean }
        );

        add(
                MyUserState.SET_AGE,
                "Welcome to the club, buddy!",
                "пчел, тыыыыыыыыыыыыыыыыыыыыыыыыыыыыыыыы",
                (input, chatId) -> { еще одна логика с возвращаемым значением типа boolean }
        );
    }
}
```

Возможно, у вас сейчас возникает много вопросов. Это нормально. По двум причинам. Во-первых - я плох в составлении документации 
и инструкций, а во вторых больше ответов на ваши вопросы последует далее. Единственное, что стоит отметить прямо здесь - 
под "логикой" выше понимается код, который будет менять состояние пользователя в базе данных на другое, а также возвращать 
true или false в зависимости от того, устраивает ли нас ввод пользователя (если нет никакой разницы просто возвращайте true).

### Внедрение стадий в бота

Для того чтобы внедрить все вышеописанное в бота, нам нужно добавить к инициализации бота вызов следующего метода:

```java
public class Main {
    public static void main(String[] args) {
        IBot bot = new BotCreator(
                "token",
                "username"
        )
                .addCommands(new MyCommandsBuilder())
                .addRegistration(new MyRegistrationBuilder(), (chatId) -> { логика определения состояния пользователя }, MyUserState.AUTHORIZED)
                .start();
    }
}
```

Что-ж, теперь по порядку. В метод addRegistration мы должны добавить 3 параметра:

- класс, созданный нами выше;
- логику определения состояния пользователя по chatId. Тут стоит отметить, что если пользователь в первый раз обращается к боту, у него 
не может быть никакого состояния, поэтому мы в конкретном примере должны вернуть UNAUTHORIZED, а в бд записать пользователю состояние
SET_NAME;
- состояние, при котором обрабатываются команды. В нашем случае это AUTHORIZED.

Поздравляю, мы добавили регистрацию в нашего бота!

to be continued...